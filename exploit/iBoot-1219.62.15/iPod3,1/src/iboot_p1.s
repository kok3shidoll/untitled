@ iboot_p1.s
@
@ Copyright (c) 2021 - 2023 @ kok3shidoll
@
@


    .text
    .syntax    unified


    .arm
_entry:
    b    _entry

    .org    0x778
    .arm
_disable_interrupts:
    bx    lr

    .org    0x17758
    .thumb_func
_arch_cpu_quiesce:
    bx    lr

    .org    0x2441c
    .arm
_bcopy:
    bx    lr


    .org    0x310fc
    .global _payload
    .thumb
    .thumb_func
_payload:
    ldr    sp, =0x4FFF8000
    blx    _disable_interrupts
    ldr    r4, =0x44000000

    ldr    r0, =0x4ff00000          @ could be 0, but we use explicit offset for iloader
    mov    r1, r4
    ldr    r2, =0x2EAC0
    blx    _bcopy

    ldr    r0, =0x11c70
    ldr    r1, =0x60182000
    str    r1, [r4, r0]             @ accept unsigned images

    ldr    r1, =0x830002d8          @ gpio_base + offsetof_homeButton
    ldr    r0, [r1]
    tst.w  r0, #0x1
    bne    _hook_main_task          @ If it's not being pushed, it'll jump to hook_main_task().

    @ Enter Recovery Mode
    ldr    r0, =0xdd4
    movs   r1, #0x2500
    strh   r1, [r4, r0]             @ env_get() is always returned as false.
    b      _back_to_orig

_hook_main_task:
    ldr    r0, =0xbe0
    ldr    r1, =0x4ff2c901          @ payload start + 1
    str    r1, [r4, r0]             @ change ptr of main_task() to payload.

    ldr    r0, =0x4ff313fc
    ldr    r1, =0x4402c900          @ payload start
    movs   r2, #0x44                @ payload_size
    blx    _bcopy
    b      _back_to_orig

_back_to_orig:
    ldr    r0, =0x4ff311fc          @ nettoyeur [ARM]
    mov    r5, r0

    bl     _arch_cpu_quiesce
    blx    r5                       @ nettoyeur()
    bx     r4

.align    2
